<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - ikkachi Music</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white min-h-screen p-8">

  <div class="flex justify-between items-center mb-8">
    <h1 class="text-3xl font-bold">Admin Panel</h1>
    <button onclick="logout()" class="bg-red-600 px-4 py-2 rounded">
      Logout
    </button>
  </div>

  <div class="bg-gray-800 rounded-lg shadow-lg p-6">
    <h2 class="text-xl mb-4">Registered Users</h2>

    <div class="overflow-x-auto">
      <table class="table-auto w-full border border-gray-700 text-sm">
        <thead>
          <tr class="bg-gray-700">
            <th class="p-3">Username</th>
            <th class="p-3">Email</th>
            <th class="p-3">Role</th>
            <th class="p-3">Created</th>
            <th class="p-3">Actions</th>
          </tr>
        </thead>
        <tbody id="userTable"></tbody>
      </table>
    </div>
  </div>

<script>

const API_BASE = "https://musickkk-3pj5.onrender.com/api";
const token = localStorage.getItem("token");

if (!token) {
  alert("Please login first");
  window.location.href = "pages/user.html";
}

// Logout
function logout() {
  localStorage.removeItem("token");
  window.location.href = "../pages/user.html";
}

// Load all users
async function loadUsers() {
  try {
    const response = await fetch(`${API_BASE}/admin/users`, {
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    if (!response.ok) {
      const data = await response.json();
      alert(data.message || "Access denied");
      window.location.href = "pages/user.html";
      return;
    }

    const users = await response.json();
    const table = document.getElementById("userTable");
    table.innerHTML = "";

    users.forEach(user => {

      const row = document.createElement("tr");
      row.className = "border border-gray-700 hover:bg-gray-700";

      row.innerHTML = `
        <td class="p-3">${user.username}</td>
        <td class="p-3">${user.email}</td>
        <td class="p-3 font-semibold">${user.role}</td>
        <td class="p-3">${new Date(user.createdAt).toLocaleDateString()}</td>
        <td class="p-3 space-x-2">

          <button onclick="deleteUser('${user._id}')"
            class="bg-red-600 px-2 py-1 rounded text-xs">
            Delete
          </button>

          ${user.role === "user" ? `
            <button onclick="promoteUser('${user._id}')"
              class="bg-blue-600 px-2 py-1 rounded text-xs">
              Promote
            </button>
          ` : ""}

          ${user.role === "admin" ? `
            <button onclick="demoteUser('${user._id}')"
              class="bg-yellow-600 px-2 py-1 rounded text-xs">
              Demote
            </button>
          ` : ""}

        </td>
      `;

      table.appendChild(row);
    });

  } catch (error) {
    console.error("Error loading users:", error);
  }
}

// Delete user
async function deleteUser(id) {

  if (!confirm("Are you sure you want to delete this user?")) return;

  const response = await fetch(`${API_BASE}/admin/users/${id}`, {
    method: "DELETE",
    headers: {
      Authorization: `Bearer ${token}`
    }
  });

  const data = await response.json();

  if (!response.ok) {
    alert(data.message);
    return;
  }

  alert(data.message);
  loadUsers();
}

// Promote user
async function promoteUser(id) {

  const response = await fetch(`${API_BASE}/admin/users/${id}/promote`, {
    method: "PUT",
    headers: {
      Authorization: `Bearer ${token}`
    }
  });

  const data = await response.json();

  if (!response.ok) {
    alert(data.message);
    return;
  }

  alert(data.message);
  loadUsers();
}

// Demote user
async function demoteUser(id) {

  const response = await fetch(`${API_BASE}/admin/users/${id}/demote`, {
    method: "PUT",
    headers: {
      Authorization: `Bearer ${token}`
    }
  });

  const data = await response.json();

  if (!response.ok) {
    alert(data.message);
    return;
  }

  alert(data.message);
  loadUsers();
}

loadUsers();

</script>

</body>
</html>